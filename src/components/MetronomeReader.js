import React, { useState, useEffect, useRef } from 'react';
import {
  Container,
  Typography,
  Box,
  Slider,
  Paper,
  useTheme,
  Button,
} from '@mui/material';
import {
  PlayArrow,
  Pause,
  ArrowBack,
} from '@mui/icons-material';
import { motion } from 'framer-motion';
import { playSound } from '../services/sound';
import { vibrate } from '../services/vibration';
import { styled } from '@mui/material/styles';
import { updateProgress } from '../services/storage';

const LONG_AFFIRMATIONS = [
  "Моя речь — это отражение внутренней гармонии, интеллекта и уважения к окружающим. Я ежедневно работаю над чистотой и выразительностью своих слов, чтобы каждое высказывание было наполнено смыслом, добротой и заботой. Я осознанно выбираю интонацию, темп и ритм, чтобы мой голос звучал мягко, уверенно и приятно для слуха. Я горжусь тем, что могу доносить свои мысли ясно и грамотно, вдохновляя других своим примером. Моя речь помогает мне строить доверительные отношения, достигать целей и создавать атмосферу взаимопонимания. Я забочусь о здоровье своего голоса, делаю дыхательные упражнения, тренирую дикцию и артикуляцию, чтобы говорить легко, свободно и без напряжения. Я уверен(а) в своих силах и с радостью делюсь своими мыслями, зная, что моя речь красива, грамотна и полезна для окружающих. Я стремлюсь к тому, чтобы каждое моё слово приносило пользу и радость людям вокруг.",
  "Я с любовью и вниманием отношусь к своему голосу и речи, ведь это мой главный инструмент для общения, самовыражения и достижения успеха. Каждый день я совершенствую свои коммуникативные навыки, учусь слушать и быть услышанным, развиваю эмпатию и уважение к собеседнику. Мои слова наполнены уважением, добротой и уверенностью, а речь становится всё более структурированной, логичной и интересной. Я умею строить содержательные высказывания, поддерживать диалог и вдохновлять собеседника на развитие. Мой голос звучит мягко, приятно и здорово, а речь помогает мне достигать успеха в личной и профессиональной жизни. Я забочусь о здоровье своих связок, делаю упражнения для дыхания, дикции и артикуляции, чтобы говорить чётко, выразительно и без усталости. Я горжусь тем, что моя речь красива, грамотна и приносит пользу окружающим, помогая строить гармоничные отношения.",
  "Моя речь — это отражение моего внутреннего мира, интеллекта, культуры и жизненного опыта. Я говорю спокойно, размеренно и уверенно, выбирая слова с любовью, вниманием и уважением к собеседнику. Я уважаю мнение других людей и всегда стараюсь быть понятным, интересным и вдохновляющим. Мой голос звучит мягко, а речь поддерживает и мотивирует окружающих на развитие. Я ежедневно работаю над чистотой и выразительностью своей речи, делаю дыхательные упражнения, тренирую дикцию и артикуляцию, чтобы говорить легко, свободно и без напряжения. Я уверен(а) в своих силах и с радостью делюсь своими мыслями, зная, что моя речь красива, грамотна и полезна для окружающих. Я умею слушать, быть услышанным, строить логичные и интересные высказывания, поддерживать диалог и создавать атмосферу доверия и взаимопонимания.",
  "Я горжусь своей грамотной, красивой и здоровой речью, ведь она помогает мне строить крепкие отношения, достигать целей и вдохновлять других на развитие. Я умею ясно выражать мысли, строить логичные, интересные и содержательные высказывания. Мой голос звучит уверенно, мягко и приятно, а слова наполняют пространство гармонией, добротой и позитивом. Я с радостью совершенствую свои коммуникативные навыки, делаю упражнения для дыхания, дикции и артикуляции. Моя речь становится всё более здоровой, выразительной и приятной для окружающих, а голос — мягким, сильным и устойчивым. Я уверен(а) в своих силах и с радостью общаюсь с людьми, зная, что моя речь красива, грамотна и полезна для всех, кто меня окружает.",
  "Я наслаждаюсь процессом общения, ведь моя речь — это инструмент для создания гармонии, взаимопонимания, поддержки и вдохновения. Я говорю красиво, грамотно и с уважением к собеседнику, умею слушать, быть услышанным и поддерживать диалог. Мой голос звучит мягко, приятно и здорово, а слова вдохновляют на развитие, добрые поступки и позитивные перемены. Я умею строить логичные, интересные и содержательные высказывания, создавать атмосферу доверия и взаимопонимания. Я забочусь о здоровье своего голоса, делаю дыхательные упражнения, тренирую дикцию и артикуляцию, чтобы говорить легко, свободно и без усталости. Я уверен(а) в своих силах и с радостью делюсь своими мыслями, зная, что моя речь красива, грамотна и полезна для окружающих.",
  "Моя речь — это мой путь к успеху, гармонии, самореализации и внутреннему росту. Я говорю чётко, ясно, грамотно и уверенно, умею поддерживать диалог, вдохновлять собеседника и создавать атмосферу доверия, уважения и взаимопонимания. Мой голос звучит мягко, приятно и здорово, а слова наполняют пространство позитивом, добротой и гармонией. Я совершенствую свою речь каждый день, делаю упражнения для голоса, дикции, дыхания и артикуляции. Моя речь становится всё более красивой, грамотной, здоровой и выразительной. Я уверен(а) в своих силах и с радостью делюсь своими мыслями, зная, что моя речь помогает мне достигать целей, строить крепкие отношения и вдохновлять окружающих на развитие и самосовершенствование.",
  "Я забочусь о своём голосе и речи, ведь это мой главный инструмент для общения, самовыражения, достижения успеха и построения гармоничных отношений. Я делаю дыхательные упражнения, тренирую дикцию и артикуляцию, чтобы моя речь становилась чище, выразительнее, приятнее и здоровее для окружающих. Я уверен(а) в своих силах и с радостью общаюсь с людьми, зная, что моя речь красива, грамотна и полезна для всех. Я умею слушать, быть услышанным, строить логичные, интересные и содержательные высказывания, поддерживать диалог и создавать атмосферу доверия, уважения и взаимопонимания. Мой голос звучит мягко, приятно и здорово, а слова наполняют пространство гармонией, добротой и позитивом.",
  "Я говорю спокойно, размеренно, уверенно и с любовью, выбирая слова с вниманием, заботой и уважением к собеседнику. Мои слова наполнены смыслом, добротой, гармонией и позитивом. Я умею слушать, быть услышанным, строить логичные, интересные и содержательные высказывания, поддерживать диалог и вдохновлять собеседника на развитие. Моя речь помогает мне строить крепкие отношения, достигать целей и создавать атмосферу доверия, уважения и взаимопонимания. Я забочусь о здоровье своего голоса, делаю дыхательные упражнения, тренирую дикцию и артикуляцию, чтобы говорить легко, свободно и без усталости. Я уверен(а) в своих силах и с радостью делюсь своими мыслями, зная, что моя речь красива, грамотна и полезна для окружающих.",
  "Моя речь — это мой инструмент для достижения успеха, гармонии, самореализации и внутреннего роста. Я говорю чётко, ясно, грамотно и уверенно, умею слушать, быть услышанным, поддерживать диалог и вдохновлять собеседника. Мой голос звучит мягко, приятно и здорово, а слова наполняют пространство позитивом, добротой и гармонией. Я совершенствую свою речь каждый день, делаю упражнения для голоса, дикции, дыхания и артикуляции. Моя речь становится всё более красивой, грамотной, здоровой и выразительной. Я уверен(а) в своих силах и с радостью делюсь своими мыслями, зная, что моя речь помогает мне достигать целей, строить крепкие отношения и вдохновлять окружающих на развитие и самосовершенствование.",
  "Я горжусь тем, как я говорю, ведь моя речь — это отражение моего внутреннего мира, интеллекта, культуры и жизненного опыта. Я выбираю слова с любовью, вниманием и уважением, строю логичные, интересные и содержательные высказывания. Мой голос звучит уверенно, мягко и приятно, а речь вдохновляет окружающих на развитие, добрые поступки и позитивные перемены. Я забочусь о здоровье своего голоса, делаю дыхательные упражнения, тренирую дикцию и артикуляцию, чтобы говорить легко, свободно и без усталости. Я уверен(а) в своих силах и с радостью делюсь своими мыслями, зная, что моя речь красива, грамотна и полезна для всех, кто меня окружает.",
  "Я с любовью отношусь к своему голосу и речи, ведь это мой главный инструмент для общения, самовыражения и достижения успеха. Каждый день я совершенствую свои коммуникативные навыки, учусь слушать, быть услышанным, развиваю эмпатию и уважение к собеседнику. Мои слова наполнены уважением, добротой и уверенностью, а речь становится всё более структурированной, логичной и интересной. Я умею строить содержательные высказывания, поддерживать диалог и вдохновлять собеседника на развитие. Мой голос звучит мягко, приятно и здорово, а речь помогает мне достигать успеха в личной и профессиональной жизни. Я забочусь о здоровье своих связок, делаю упражнения для дыхания, дикции и артикуляции, чтобы говорить чётко, выразительно и без усталости. Я горжусь тем, что моя речь красива, грамотна и приносит пользу окружающим, помогая строить гармоничные отношения.",
  "Я забочусь о своём голосе и речи, ведь это мой главный инструмент для общения, самовыражения, достижения успеха и построения гармоничных отношений. Я делаю дыхательные упражнения, тренирую дикцию и артикуляцию, чтобы моя речь становилась чище, выразительнее, приятнее и здоровее для окружающих. Я уверен(а) в своих силах и с радостью общаюсь с людьми, зная, что моя речь красива, грамотна и полезна для всех. Я умею слушать, быть услышанным, строить логичные, интересные и содержательные высказывания, поддерживать диалог и создавать атмосферу доверия, уважения и взаимопонимания. Мой голос звучит мягко, приятно и здорово, а слова наполняют пространство гармонией, добротой и позитивом.",
  "Моя речь — это отражение моего внутреннего мира, интеллекта, культуры и жизненного опыта. Я говорю спокойно, размеренно и уверенно, выбирая слова с любовью, вниманием и уважением к собеседнику. Я уважаю мнение других людей и всегда стараюсь быть понятным, интересным и вдохновляющим. Мой голос звучит мягко, а речь поддерживает и мотивирует окружающих на развитие. Я ежедневно работаю над чистотой и выразительностью своей речи, делаю дыхательные упражнения, тренирую дикцию и артикуляцию, чтобы говорить легко, свободно и без напряжения. Я уверен(а) в своих силах и с радостью делюсь своими мыслями, зная, что моя речь красива, грамотна и полезна для окружающих. Я умею слушать, быть услышанным, строить логичные и интересные высказывания, поддерживать диалог и создавать атмосферу доверия и взаимопонимания.",
  "Я наслаждаюсь процессом общения, ведь моя речь — это инструмент для создания гармонии, взаимопонимания, поддержки и вдохновения. Я говорю красиво, грамотно и с уважением к собеседнику, умею слушать, быть услышанным и поддерживать диалог. Мой голос звучит мягко, приятно и здорово, а слова вдохновляют на развитие, добрые поступки и позитивные перемены. Я умею строить логичные, интересные и содержательные высказывания, создавать атмосферу доверия и взаимопонимания. Я забочусь о здоровье своего голоса, делаю дыхательные упражнения, тренирую дикцию и артикуляцию, чтобы говорить легко, свободно и без усталости. Я уверен(а) в своих силах и с радостью делюсь своими мыслями, зная, что моя речь красива, грамотна и полезна для окружающих.",
  "Я говорю спокойно, размеренно, уверенно и с любовью, выбирая слова с вниманием, заботой и уважением к собеседнику. Мои слова наполнены смыслом, добротой, гармонией и позитивом. Я умею слушать, быть услышанным, строить логичные, интересные и содержательные высказывания, поддерживать диалог и вдохновлять собеседника на развитие. Моя речь помогает мне строить крепкие отношения, достигать целей и создавать атмосферу доверия, уважения и взаимопонимания. Я забочусь о здоровье своего голоса, делаю дыхательные упражнения, тренирую дикцию и артикуляцию, чтобы говорить легко, свободно и без усталости. Я уверен(а) в своих силах и с радостью делюсь своими мыслями, зная, что моя речь красива, грамотна и полезна для окружающих.",
  "Моя речь — это мой путь к успеху, гармонии, самореализации и внутреннему росту. Я говорю чётко, ясно, грамотно и уверенно, умею поддерживать диалог, вдохновлять собеседника и создавать атмосферу доверия, уважения и взаимопонимания. Мой голос звучит мягко, приятно и здорово, а слова наполняют пространство позитивом, добротой и гармонией. Я совершенствую свою речь каждый день, делаю упражнения для голоса, дикции, дыхания и артикуляции. Моя речь становится всё более красивой, грамотной, здоровой и выразительной. Я уверен(а) в своих силах и с радостью делюсь своими мыслями, зная, что моя речь помогает мне достигать целей, строить крепкие отношения и вдохновлять окружающих на развитие и самосовершенствование.",
  "Я уверен(а) в своём голосе и речи. Я умею слушать, быть услышанным, строить логичные, интересные и содержательные высказывания, поддерживать диалог и создавать атмосферу доверия, уважения и взаимопонимания. Моя речь помогает мне строить крепкие отношения, достигать целей и вдохновлять окружающих на развитие. Я забочусь о здоровье своего голоса, делаю дыхательные упражнения, тренирую дикцию и артикуляцию, чтобы говорить легко, свободно и без усталости. Я уверен(а) в своих силах и с радостью делюсь своими мыслями, зная, что моя речь красива, грамотна и полезна для всех, кто меня окружает.",
  "Я говорю легко, свободно, уверенно и с любовью, выбирая слова с вниманием, заботой и уважением к собеседнику. Мои слова наполнены смыслом, добротой, гармонией и позитивом. Я умею строить логичные, интересные и содержательные высказывания, поддерживать диалог и вдохновлять собеседника на развитие. Моя речь помогает мне строить крепкие отношения, достигать целей и создавать атмосферу доверия, уважения и взаимопонимания. Я забочусь о здоровье своего голоса, делаю дыхательные упражнения, тренирую дикцию и артикуляцию, чтобы говорить легко, свободно и без усталости. Я уверен(а) в своих силах и с радостью делюсь своими мыслями, зная, что моя речь красива, грамотна и полезна для окружающих.",
  "Я совершенствую свою речь каждый день, делаю упражнения для голоса, дикции, дыхания и артикуляции. Моя речь становится всё более красивой, грамотной, здоровой и выразительной. Я уверен(а) в своих силах и с радостью делюсь своими мыслями, зная, что моя речь помогает мне достигать целей, строить крепкие отношения и вдохновлять окружающих на развитие и самосовершенствование. Мой голос звучит мягко, приятно и здорово, а слова наполняют пространство позитивом, добротой и гармонией. Я умею слушать, быть услышанным, строить логичные, интересные и содержательные высказывания, поддерживать диалог и создавать атмосферу доверия, уважения и взаимопонимания."
];

// Кастомный шарик для Slider
const CustomThumb = styled('span')(({ theme, ownerState }) => ({
  width: 24,
  height: 24,
  backgroundColor: '#29b6f6',
  borderRadius: '50%',
  boxShadow: '0 2px 8px 0 #2196f355',
  border: '3px solid #fff',
  display: 'block',
  position: 'absolute',
  top: '50%',
  left: 0,
  transform: 'translateY(-50%)',
}));

const MetronomeReader = () => {
  const theme = useTheme();
  const [isPlaying, setIsPlaying] = useState(false);
  const [bpm, setBpm] = useState(60);
  const [currentWordIndex, setCurrentWordIndex] = useState(-1);
  const [longAffirmation, setLongAffirmation] = useState('');
  const audioContextRef = useRef(null);
  const nextNoteTimeRef = useRef(0);
  const scheduledNotesRef = useRef([]);
  const animationFrameRef = useRef(null);
  const wordsRef = useRef([]);
  const [words, setWords] = useState([]);
  const textBoxRef = useRef(null);
  const lastActiveRef = useRef(null);

  useEffect(() => {
    audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
    return () => {
      if (audioContextRef.current) audioContextRef.current.close();
      if (animationFrameRef.current) cancelAnimationFrame(animationFrameRef.current);
    };
  }, []);

  useEffect(() => {
    handleGenerateAffirmation();
  }, []);

  useEffect(() => {
    if (isPlaying) {
      animationFrameRef.current = requestAnimationFrame(scheduler);
    } else {
      cancelAnimationFrame(animationFrameRef.current);
      setCurrentWordIndex(-1);
      setTimeout(() => {
        if (textBoxRef.current) {
          textBoxRef.current.scrollTo({ top: 0, behavior: 'smooth' });
        }
      }, 350);
    }
    return () => cancelAnimationFrame(animationFrameRef.current);
    // eslint-disable-next-line
  }, [isPlaying, bpm, words.length]);

  useEffect(() => {
    if (lastActiveRef.current && textBoxRef.current) {
      const el = lastActiveRef.current;
      const box = textBoxRef.current;
      const elRect = el.getBoundingClientRect();
      const boxRect = box.getBoundingClientRect();
      if (elRect.bottom > boxRect.bottom - 8) {
        el.scrollIntoView({ block: 'end', behavior: 'smooth' });
      }
    }
  }, [currentWordIndex]);

  const scheduleNote = (time) => {
    const osc = audioContextRef.current.createOscillator();
    const gainNode = audioContextRef.current.createGain();
    osc.connect(gainNode);
    gainNode.connect(audioContextRef.current.destination);
    osc.frequency.value = 1000;
    gainNode.gain.value = 0.5;
    osc.start(time);
    osc.stop(time + 0.1);
    scheduledNotesRef.current.push({ osc, gainNode, time });
    scheduledNotesRef.current = scheduledNotesRef.current.filter(note => note.time > time - 0.5);
  };

  const scheduler = () => {
    const currentTime = audioContextRef.current.currentTime;
    while (nextNoteTimeRef.current < currentTime + 0.1) {
      scheduleNote(nextNoteTimeRef.current);
      nextNoteTimeRef.current += 60.0 / bpm;
      if (isPlaying && words.length > 0) {
        setCurrentWordIndex(prev => {
          if (prev === -1) return 0;
          if (prev + 1 >= words.length) return 0;
          return prev + 1;
        });
      }
    }
    animationFrameRef.current = requestAnimationFrame(scheduler);
  };

  const handlePlayPause = () => {
    if (!longAffirmation) return;
    if (!isPlaying) {
      if (audioContextRef.current.state === 'suspended') audioContextRef.current.resume();
      nextNoteTimeRef.current = audioContextRef.current.currentTime;
      scheduler();
      setIsPlaying(true);
      playSound('click');
      vibrate('click');
    } else {
      cancelAnimationFrame(animationFrameRef.current);
      setIsPlaying(false);
      playSound('click');
      vibrate('click');
      handleExerciseComplete();
    }
  };

  const handleBpmChange = (event, newValue) => {
    if (typeof newValue === 'number') {
      setBpm(newValue);
      playSound('click');
      vibrate('click');
    }
  };

  const handleGenerateAffirmation = () => {
    const idx = Math.floor(Math.random() * LONG_AFFIRMATIONS.length);
    setLongAffirmation(LONG_AFFIRMATIONS[idx]);
    const splitWords = LONG_AFFIRMATIONS[idx].split(/\s+/).filter(word => word.length > 0);
    setWords(splitWords);
    wordsRef.current = splitWords;
    setCurrentWordIndex(-1);
    setIsPlaying(false);
  };

  const handleExerciseComplete = () => {
    updateProgress('metronome');
  };

  return (
    <Box sx={{ 
      height: '100vh', 
      width: '100%', 
      overflow: 'hidden',
      position: 'fixed',
      top: 0,
      left: 0,
      right: 0,
      bottom: 0,
      backgroundColor: theme.palette.background.default
    }}>
      <Container maxWidth="sm" sx={{ 
        height: '100%', 
        display: 'flex', 
        flexDirection: 'column',
        overflow: 'hidden',
        position: 'relative'
      }}>
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.5 }}
          style={{ width: '100%' }}
        >
          <Box
            sx={{
              p: { xs: 1.5, sm: 2 },
              borderRadius: 3,
              background: theme.palette.mode === 'dark' 
                ? 'linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%)' 
                : 'linear-gradient(135deg, #fffefb 0%, #fffde4 100%)',
              border: `1px solid ${theme.palette.divider}`,
              mb: 3,
              width: '90%',
              maxWidth: '100%',
              minWidth: '280px',
              height: 'auto',
              display: 'flex',
              flexDirection: 'column',
              alignItems: 'center',
              justifyContent: 'flex-start',
              mx: 'auto',
            }}
          >
            <Box
              sx={{
                width: '100%',
                background: 'linear-gradient(90deg, #2196f3 0%, #1e88e5 100%)',
                borderRadius: 2,
                mb: 2,
                py: 2,
                display: 'flex',
                justifyContent: 'center',
                alignItems: 'center',
                boxShadow: '0 2px 8px 0 rgba(0,0,0,0.08)',
              }}
            >
              <Typography 
                variant="h5" 
                align="center" 
                sx={{ 
                  color: '#fff',
                  fontWeight: 'bold',
                  textShadow: '0 2px 8px rgba(0,0,0,0.15)',
                  m: 0,
                }}
              >
                Чтение с метрономом
              </Typography>
            </Box>
            <Typography
              variant="body2"
              align="center"
              sx={{ mb: 2, color: 'text.primary' }}
            >
              Читайте текст вслух, синхронизируя слова с метрономом.
            </Typography>

            <Box sx={{ mb: 0.5, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
              <Typography variant="caption" color="text.secondary"></Typography>
              <Typography variant="caption" sx={{ fontWeight: 500 }}>Темп (BPM):</Typography>
              <Typography variant="caption" color="text.secondary"></Typography>
            </Box>
            <Slider
              value={bpm}
              min={40}
              max={160}
              step={1}
              onChange={handleBpmChange}
              sx={{
                mb: 2,
                mx: 'auto',
                width: '90%',
                py: 2,
                '& .MuiSlider-rail': {
                  height: 6,
                  borderRadius: 3,
                },
                '& .MuiSlider-track': {
                  height: 6,
                  borderRadius: 3,
                },
              }}
              valueLabelDisplay="auto"
              slots={{ thumb: CustomThumb }}
            />
            <Box sx={{ display: 'flex', justifyContent: 'center', mb: 2 }}>
              <motion.div
                initial={{ scale: 1 }}
                animate={{ scale: isPlaying ? 1.08 : 1 }}
                transition={{ type: 'spring', stiffness: 300 }}
              >
                <Button
                  onClick={handlePlayPause}
                  sx={{
                    width: 56,
                    height: 56,
                    borderRadius: '50%',
                    minWidth: 0,
                    boxShadow: '0 2px 12px 0 #ff3366a0',
                    background: 'linear-gradient(135deg, #ff3366 0%, #ff5e62 100%)',
                    color: '#fff',
                    fontSize: 32,
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    transition: 'all 0.2s',
                    '&:hover': {
                      background: 'linear-gradient(135deg, #ff5e62 0%, #ff3366 100%)',
                      boxShadow: '0 4px 16px 0 #ff3366a0',
                    },
                  }}
                >
                  {isPlaying ? <Pause fontSize="inherit" /> : <PlayArrow fontSize="inherit" />}
                </Button>
              </motion.div>
            </Box>
            
            {words.length > 0 && (
              <Box
                sx={{
                  p: 1.5,
                  mb: 3,
                  borderRadius: 4,
                  background: theme.palette.mode === 'dark' ? '#2d2d2d' : '#fff',
                  boxShadow: theme.palette.mode === 'dark' 
                    ? '0 4px 24px 0 rgba(0,0,0,0.3)' 
                    : '0 4px 24px 0 rgba(60,60,120,0.10)',
                  fontSize: 15,
                  color: theme.palette.text.primary,
                  fontWeight: 500,
                  textAlign: 'center',
                  minHeight: 40,
                  display: 'flex',
                  flexWrap: 'wrap',
                  gap: 0.5,
                  justifyContent: 'center',
                  alignItems: 'center',
                  lineHeight: 1.5,
                  maxHeight: 180,
                  overflowY: 'auto',
                  userSelect: 'none',
                  letterSpacing: '-0.01em',
                  wordBreak: 'break-word',
                }}
                ref={textBoxRef}
              >
                {words.map((word, idx) => {
                  const isActive = idx === currentWordIndex;
                  return (
                    <span
                      key={idx}
                      style={{
                        background: isActive ? 'rgba(33,150,243,0.18)' : 'transparent',
                        color: isActive ? '#1976d2' : theme.palette.text.primary,
                        borderRadius: isActive ? 5 : 0,
                        padding: '1px 4px',
                        margin: '0 0.5px',
                        fontWeight: 500,
                        transition: 'background 0.2s, color 0.4s cubic-bezier(0.4,0,0.2,1)',
                        fontSize: 15,
                        wordBreak: 'break-word',
                        whiteSpace: 'pre-line',
                        boxShadow: isActive ? '0 2px 8px 0 #2196f355' : 'none',
                      }}
                      ref={isActive ? lastActiveRef : null}
                    >
                      {word}
                    </span>
                  );
                })}
              </Box>
            )}
            
            <Typography
              variant="caption"
              align="center"
              sx={{ mb: 2, display: 'block', color: theme.palette.text.primary, fontWeight: 500 }}
            >
              Повторите 3–5 раз, стараясь сохранять ритм.
            </Typography>

            <Box sx={{ display: 'flex', flexDirection: 'column', gap: 1.5, width: '100%', mt: 1 }}>
              <Button
                variant="contained"
                color="primary"
                onClick={handleGenerateAffirmation}
                sx={{
                  py: 1,
                  px: 2.5,
                  borderRadius: 30,
                  fontWeight: 500,
                  fontSize: '0.95rem',
                  minWidth: 0,
                  width: 'auto',
                  alignSelf: 'center',
                  backgroundColor: '#ff3366',
                  '&:hover': {
                    backgroundColor: '#e0294d',
                  },
                }}
              >
                Сгенерировать аффирмацию
              </Button>
              <Button
                variant="contained"
                color="primary"
                startIcon={<ArrowBack />}
                onClick={() => window.history.back()}
                sx={{
                  py: 1,
                  px: 2.5,
                  borderRadius: 30,
                  fontWeight: 500,
                  fontSize: '0.95rem',
                  minWidth: 0,
                  width: 'auto',
                  alignSelf: 'center',
                  backgroundColor: '#ff3366',
                  '&:hover': {
                    backgroundColor: '#e0294d',
                  },
                }}
              >
                Назад
              </Button>
            </Box>
          </Box>
        </motion.div>
      </Container>
    </Box>
  );
};

export default MetronomeReader; 