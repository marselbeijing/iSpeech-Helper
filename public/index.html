<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="%PUBLIC_URL%/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta
      name="description"
      content="iSpeech Helper - –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–º–æ—â–∏ –ª—é–¥—è–º —Å —Ä–µ—á–µ–≤—ã–º–∏ —Ä–∞—Å—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏"
    />
    <link rel="apple-touch-icon" href="%PUBLIC_URL%/logo192.png" />
    <link rel="manifest" href="%PUBLIC_URL%/manifest.json" />
    <title>iSpeech Helper</title>
  </head>
  <body>
    <noscript>–î–ª—è —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–∫–ª—é—á–∏—Ç—å JavaScript.</noscript>
    <div id="root"></div>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- TG Analytics -->
    <script>
      // üéØ –°–û–ë–°–¢–í–ï–ù–ù–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø TG Analytics API —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
      // https://tganalytics.xyz/docs
      
      const TG_ANALYTICS_CONFIG = {
        enabled: true, // –í–∫–ª—é—á–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π
        apiUrl: 'https://tganalytics.xyz/events',
        token: 'eyJhcHBfbmFtZSI6ImlzcGVlY2hfaGVscGVyX2FuYWx5dGljcyIsImFwcF91cmwiOiJodHRwczovL3QubWUvaVNwZWVjaEhlbHBlcl9ib3QiLCJhcHBfZG9tYWluIjoiaHR0cHM6Ly9pLXNwZWVjaC1oZWxwZXItdWNlNC52ZXJjZWwuYXBwIn0=!j9+Ln94Vror//YszMapC2bBcM7JNJ3tyOVLFnAUI7xg=',
        appName: 'ispeech_helper_analytics'
      };
      
      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π session_id (UUID)
      function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
          const r = Math.random() * 16 | 0;
          const v = c === 'x' ? r : (r & 0x3 | 0x8);
          return v.toString(16);
        });
      }
      
      const sessionId = generateUUID();
      
      // –°–æ–±—Å—Ç–≤–µ–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è TG Analytics
      class CustomTGAnalytics {
        constructor(config) {
          this.config = config;
          this.sessionId = sessionId;
          console.log('üîÑ Custom TG Analytics: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —Å session_id:', this.sessionId);
        }
        
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram WebApp
        getUserData() {
          const webApp = window.Telegram?.WebApp;
          if (!webApp) {
            console.warn('‚ö†Ô∏è Telegram WebApp –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
            return null;
          }
          
          return {
            user_id: webApp.initDataUnsafe?.user?.id || 12345, // fallback –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            is_premium: webApp.initDataUnsafe?.user?.is_premium || false,
            platform: webApp.platform || 'unknown',
            locale: webApp.initDataUnsafe?.user?.language_code || 'en',
            start_param: webApp.initDataUnsafe?.start_param || ''
          };
        }
        
        // –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Å–æ–±—ã—Ç–∏—è —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
        getSupportedEvents() {
          return [
            'app-init', 'app-hide', 'custom-event',
            'connection-started', 'connection-completed', 'connection-error',
            'connection-restoring-completed', 'connection-restoring-error',
            'transaction-sent-for-signature', 'transaction-signed', 'transaction-signing-failed',
            'disconnection'
          ];
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏—è —Å–æ–≥–ª–∞—Å–Ω–æ API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
        async track(eventName, customData = {}) {
          if (!this.config.enabled) {
            console.log('üîï TG Analytics –æ—Ç–∫–ª—é—á–µ–Ω');
            return;
          }
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –ª–∏ —Å–æ–±—ã—Ç–∏–µ
          if (!this.getSupportedEvents().includes(eventName)) {
            console.warn(`‚ö†Ô∏è TG Analytics: –°–æ–±—ã—Ç–∏–µ "${eventName}" –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ "custom-event" –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å–æ–±—ã—Ç–∏–π.`);
            return;
          }
          
          const userData = this.getUserData();
          if (!userData) {
            console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            return;
          }
          
          // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏–µ —Å–æ–≥–ª–∞—Å–Ω–æ API —Å—Ö–µ–º–µ
          const event = {
            event_name: eventName,
            session_id: this.sessionId,
            user_id: userData.user_id,
            app_name: this.config.appName,
            is_premium: userData.is_premium,
            platform: userData.platform,
            locale: userData.locale,
            start_param: userData.start_param,
            client_timestamp: Date.now().toString(),
            url_referer: window.location.href,
            scope: 'miniapp',
            custom_data: customData
          };
          
          // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏—Ö —Å–æ–±—ã—Ç–∏–π
          if (eventName.includes('connection') || eventName.includes('transaction') || eventName === 'disconnection') {
            // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ TON Connect –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞
            if (customData.is_success !== undefined) event.is_success = customData.is_success;
            if (customData.error_message) event.error_message = customData.error_message;
            if (customData.error_code) event.error_code = customData.error_code;
            if (customData.wallet_address) event.wallet_address = customData.wallet_address;
            if (customData.wallet_type) event.wallet_type = customData.wallet_type;
            if (customData.wallet_version) event.wallet_version = customData.wallet_version;
            if (customData.auth_type !== undefined) event.auth_type = customData.auth_type;
          }
          
          // –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
          const headers = {
            'TGA-Auth-Token': this.config.token,
            'Content-Type': 'application/json'
          };
          
          try {
            console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ:', eventName, event);
            
            const response = await fetch(this.config.apiUrl, {
              method: 'POST',
              headers: headers,
              body: JSON.stringify([event]) // API –æ–∂–∏–¥–∞–µ—Ç –º–∞—Å—Å–∏–≤ —Å–æ–±—ã—Ç–∏–π
            });
            
            if (response.ok) {
              const result = await response.json();
              console.log('‚úÖ TG Analytics —Å–æ–±—ã—Ç–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ:', eventName, result);
            } else {
              const errorText = await response.text();
              console.error('‚ùå TG Analytics –æ—à–∏–±–∫–∞', response.status, ':', errorText);
              
              // –ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ—à–∏–±–æ–∫
              if (response.status === 400) {
                console.error('üîç –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –æ—à–∏–±–∫–∏ 400:');
                console.error('- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –∏–ª–∏ —Ñ–æ—Ä–º–∞—Ç');
                console.error('- –ù–µ–≤–µ—Ä–Ω–æ–µ app_name');
                console.error('- –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–æ–ª–µ–π');
                console.error('- –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ:', event);
              } else if (response.status === 403) {
                console.error('üîç –û—à–∏–±–∫–∞ 403: –î–æ–º–µ–Ω –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç–æ–∫–µ–Ω—É');
              } else if (response.status === 429) {
                console.error('üîç –û—à–∏–±–∫–∞ 429: –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤');
              }
            }
          } catch (error) {
            console.error('‚ùå TG Analytics —Å–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞:', error);
          }
        }
        
        // –ú–µ—Ç–æ–¥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
        init() {
          this.track('app-init');
          this.setupTelegramEventListeners();
        }
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª–µ–π —Å–æ–±—ã—Ç–∏–π Telegram WebApp
        setupTelegramEventListeners() {
          if (window.Telegram?.WebApp) {
            // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–∫—Ä—ã—Ç–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            window.Telegram.WebApp.onEvent('viewportChanged', (data) => {
              if (data && !data.is_expanded) {
                this.track('app-hide');
              }
            });
            
            console.log('‚úÖ TG Analytics: –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã —Å–ª—É—à–∞—Ç–µ–ª–∏ —Å–æ–±—ã—Ç–∏–π Telegram WebApp');
          }
        }
        
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è TON Connect –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
        trackConnectionStarted(customData = {}) {
          this.track('connection-started', customData);
        }
        
        trackConnectionCompleted(walletData = {}) {
          this.track('connection-completed', {
            is_success: true,
            ...walletData
          });
        }
        
        trackConnectionError(error = {}) {
          this.track('connection-error', {
            is_success: false,
            error_message: error.message || 'Connection failed',
            error_code: error.code || null,
            ...error
          });
        }
        
        trackDisconnection(walletData = {}) {
          this.track('disconnection', walletData);
        }
      }
      
      // –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –Ω–∞—à–µ–≥–æ TG Analytics
      window.telegramAnalytics = new CustomTGAnalytics(TG_ANALYTICS_CONFIG);
      
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          setTimeout(() => window.telegramAnalytics.init(), 1000);
        });
      } else {
        setTimeout(() => window.telegramAnalytics.init(), 1000);
      }
      
      console.log('‚úÖ Custom TG Analytics –∑–∞–≥—Ä—É–∂–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é');
    </script>
  </body>
</html> 